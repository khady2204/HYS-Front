import{a as ee}from"./chunk-M3YTEPZY.js";import{a as te}from"./chunk-YDNSLJXR.js";import{c as X,l as Z}from"./chunk-YVFP7G2U.js";import"./chunk-POA22WFE.js";import"./chunk-QUJFQN2Y.js";import"./chunk-6D27DZ34.js";import"./chunk-3NODV7JW.js";import"./chunk-547OZNO4.js";import"./chunk-JX6BS7SJ.js";import"./chunk-3TIPS6QV.js";import"./chunk-BSAYALUA.js";import"./chunk-7FY2OE2O.js";import"./chunk-J2OL6VUA.js";import"./chunk-GSIDHORN.js";import"./chunk-ET25664Q.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-JWWC77AT.js";import"./chunk-CKP3SGE2.js";import"./chunk-5IOERQT4.js";import{a as K}from"./chunk-NUWLO4TS.js";import{f as Y,h as Q}from"./chunk-RETT3Y54.js";import{Ac as G,Bb as U,Cb as j,Da as T,Db as A,Ha as y,Ub as O,Va as c,W as h,Wa as o,Wb as z,X as f,Xa as d,Xb as L,Ya as p,Yb as W,bc as $,cc as N,fb as w,gb as _,ib as u,jc as q,mb as k,nb as D,nc as H,ob as F,qa as b,qb as v,qc as J,rb as E,sa as s,sb as C,tb as P,ub as R,vb as V,wb as B,xa as x}from"./chunk-WVCMXTPH.js";import"./chunk-HFL6MWQG.js";import"./chunk-UJWRXINH.js";import"./chunk-4XRDT473.js";import"./chunk-OAZACCPN.js";import"./chunk-CLDSZD2A.js";import"./chunk-M2X7KQLB.js";import"./chunk-HHPFJLTL.js";import"./chunk-OZYWYLNK.js";import"./chunk-42C7ZIID.js";import{a as M}from"./chunk-JHI3MBHO.js";var se=["bottom"],ae=(r,a)=>({"justify-content-end":r,"justify-content-start":a}),oe=(r,a)=>({sent:r,received:a});function le(r,a){r&1&&(o(0,"div",23),v(1," Aucune discussion trouv\xE9e. "),d())}function de(r,a){if(r&1&&(o(0,"div",29)(1,"span",30),v(2),d()()),r&2){let i=u().$implicit,n=u();s(2),C(" ",n.formatDate(i.timestamp)," ")}}function ce(r,a){if(r&1&&(o(0,"div"),v(1),d()),r&2){let i=u().$implicit;s(),C(" ",i.content," ")}}function ue(r,a){if(r&1&&(o(0,"div"),p(1,"img",31),d()),r&2){let i=u().$implicit;s(),c("src",i.mediaUrl,b)}}function me(r,a){if(r&1&&(o(0,"div"),p(1,"video",32),d()),r&2){let i=u().$implicit;s(),c("src",i.mediaUrl,b)}}function pe(r,a){if(r&1&&(o(0,"div"),p(1,"audio",33),o(2,"small",9),v(3),d()()),r&2){let i=u().$implicit;s(),c("src",i.mediaUrl,b),s(2),C("",i.audioDuration,"s")}}function ge(r,a){if(r&1&&(o(0,"div"),y(1,de,3,1,"div",24),o(2,"div",25)(3,"div",26),y(4,ce,2,1,"div",27)(5,ue,2,1,"div",27)(6,me,2,1,"div",27)(7,pe,4,2,"div",27),o(8,"div",28),v(9),j(10,"date"),d()()()()),r&2){let i=a.$implicit,n=a.index,e=u();s(),c("ngIf",n===0||!e.isSameDate(e.messages[n-1].timestamp,i.timestamp)),s(),c("ngClass",U(11,ae,i.senderId===e.currentUserId,i.senderId!==e.currentUserId)),s(),c("ngClass",U(14,oe,i.senderId===e.currentUserId,i.senderId!==e.currentUserId)),s(),c("ngIf",i.content),s(),c("ngIf",i.mediaType==="image"&&i.mediaUrl),s(),c("ngIf",i.mediaType==="video"&&i.mediaUrl),s(),c("ngIf",i.mediaType==="audio"&&i.mediaUrl),s(2),C(" ",A(10,8,i.timestamp,"shortTime")," ")}}function he(r,a){if(r&1&&(o(0,"div"),p(1,"img",36),d()),r&2){let i=u(2);s(),c("src",i.previewUrl,b)}}function fe(r,a){if(r&1&&(o(0,"div"),p(1,"video",32),d()),r&2){let i=u(2);s(),c("src",i.previewUrl,b)}}function ve(r,a){if(r&1){let i=w();o(0,"div",34)(1,"button",35),_("click",function(){h(i);let e=u();return f(e.removeSelectedFile())}),v(2," \u2716 "),d(),y(3,he,2,1,"div",27)(4,fe,2,1,"div",27),d()}if(r&2){let i=u();s(3),c("ngIf",i.selectedFile==null||i.selectedFile.type==null?null:i.selectedFile.type.startsWith("image")),s(),c("ngIf",i.selectedFile==null||i.selectedFile.type==null?null:i.selectedFile.type.startsWith("video"))}}function _e(r,a){if(r&1){let i=w();o(0,"button",37),_("click",function(){h(i);let e=u();return f(e.startRecording())}),p(1,"i",38),d()}}function be(r,a){if(r&1){let i=w();o(0,"button",37),_("click",function(){h(i);let e=u();return f(e.stopRecording())}),p(1,"i",39),d()}}var Fe=(()=>{let a=class a{constructor(n,e,t,l,m,g){this.location=n,this.router=e,this.route=t,this.authService=l,this.messageService=m,this.userService=g,this.messages=[],this.currentUserId=null,this.newMessage="",this.selectedFile=null,this.previewUrl=null,this.audioChunks=[],this.audioBlob=null,this.audioUrl=null,this.isRecording=!1,this.audioDuration=0}ngAfterViewInit(){this.scrollToBottom()}ngOnInit(){if(!this.authService.getToken()){this.router.navigate(["/login"]);return}this.currentUserId=this.authService.getUserId()??null;let t=this.router.getCurrentNavigation()?.extras?.state?.user;if(t)this.user=M({id:t.id??t.userId},t),this.loadMessages();else{let l=this.route.snapshot.paramMap.get("userId"),m=l?parseInt(l,10):null;m&&this.userService.getProfile(m).subscribe({next:g=>{this.user=M({id:m},g),this.loadMessages()},error:g=>console.error("Erreur chargement profil :",g)})}}loadMessages(){!this.user?.id||!this.currentUserId||this.messageService.getMessageWithUser(this.user.id,this.currentUserId).subscribe({next:n=>{this.messages=n,setTimeout(()=>this.scrollToBottom(),100)},error:n=>console.error("Erreur chargement messages:",n)})}onFileSelected(n){let e=n.target.files[0];if(e){this.selectedFile=e;let t=new FileReader;t.onload=l=>this.previewUrl=l.target.result,t.readAsDataURL(e)}}removeSelectedFile(){this.selectedFile=null,this.previewUrl=null}startRecording(){navigator.mediaDevices.getUserMedia({audio:!0}).then(n=>{this.mediaRecorder=new MediaRecorder(n),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>this.audioChunks.push(e.data),this.mediaRecorder.onstop=()=>{this.audioBlob=new Blob(this.audioChunks,{type:"audio/webm"}),this.audioUrl=URL.createObjectURL(this.audioBlob);let e=new Audio(this.audioUrl);e.onloadedmetadata=()=>{this.audioDuration=Math.round(e.duration)||0,this.sendAudioMessage()}},this.mediaRecorder.start(),this.isRecording=!0}).catch(n=>console.error("Erreur micro :",n))}stopRecording(){this.mediaRecorder&&this.isRecording&&(this.mediaRecorder.stop(),this.isRecording=!1)}sendAudioMessage(){if(!this.audioBlob||!this.user?.id)return;let n=new FormData;n.append("receiverId",this.user.id.toString()),n.append("mediaFile",this.audioBlob,"audio.webm"),n.append("mediaType","audio"),n.append("audioDuration",this.audioDuration.toString()),this.messageService.sendMessage(n).subscribe({next:e=>{this.messages.push(e),this.audioBlob=null,this.audioUrl=null,setTimeout(()=>this.scrollToBottom(),100)},error:e=>console.error("Erreur envoi audio :",e)})}sendMessage(){if(!this.newMessage.trim()&&!this.selectedFile||!this.currentUserId||!this.user?.id)return;let n=new FormData;n.append("receiverId",this.user.id.toString()),this.newMessage.trim()&&n.append("content",this.newMessage.trim()),this.selectedFile&&(n.append("mediaFile",this.selectedFile),n.append("mediaType",this.selectedFile.type.startsWith("image")?"image":"video")),this.messageService.sendMessage(n).subscribe({next:e=>{this.messages.push(e),this.newMessage="",this.selectedFile=null,this.previewUrl=null;let t=document.querySelector('input[type="file"]');t&&(t.value=""),setTimeout(()=>this.scrollToBottom(),100)},error:e=>console.error("Erreur envoi message :",e)})}goBack(){this.location.back()}isSameDate(n,e){let t=new Date(n),l=new Date(e);return t.getFullYear()===l.getFullYear()&&t.getMonth()===l.getMonth()&&t.getDate()===l.getDate()}formatDate(n){let e=new Date(n),t=new Date,l=new Date(t);l.setDate(t.getDate()-1);let m=(I,S)=>I.getFullYear()===S.getFullYear()&&I.getMonth()===S.getMonth()&&I.getDate()===S.getDate();if(m(e,t))return"Aujourd'hui";if(m(e,l))return"Hier";if((t.getTime()-e.getTime())/(1e3*3600*24)<7)return["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"][e.getDay()];let ie=("0"+e.getDate()).slice(-2),ne=("0"+(e.getMonth()+1)).slice(-2),re=e.getFullYear();return`${ie}/${ne}/${re}`}scrollToBottom(){try{this.bottomRef?.nativeElement?.scrollIntoView({behavior:"smooth"})}catch(n){console.error("Erreur scroll :",n)}}};a.\u0275fac=function(e){return new(e||a)(x(O),x(Q),x(Y),x(K),x(ee),x(te))},a.\u0275cmp=T({type:a,selectors:[["app-chat"]],viewQuery:function(e,t){if(e&1&&k(se,5),e&2){let l;D(l=F())&&(t.bottomRef=l.first)}},decls:27,vars:10,consts:[["messageContainer",""],["bottom",""],[1,"bg-white"],[1,"d-flex","flex-column","vh-100"],[1,"chat-header","d-flex","align-items-center","gap-3","px-3","pt-4","pb-3","border-bottom"],[1,"bi","bi-arrow-left","fs-4",3,"click"],["width","40","height","40",1,"rounded-circle",3,"src"],[1,"ms-1"],[1,"mb-0","fw-bold"],[1,"text-muted"],[1,"flex-grow-1","overflow-auto","px-3"],["class","text-center text-muted mt-5",4,"ngIf"],[4,"ngFor","ngForOf"],["class","p-2 position-relative","style","display:inline-block;",4,"ngIf"],[1,"chat-input","d-flex","align-items-center","p-3","border-top","gap-3","bg-white"],[1,"mb-0"],[1,"bi","bi-paperclip","fs-5",2,"cursor","pointer"],["type","file","accept","image/*,video/*",2,"display","none",3,"change"],["type","text","placeholder","Message",1,"form-control","rounded-pill",2,"background","#f5f5f5","border","none",3,"ngModelChange","keydown.enter","ngModel"],["type","button","class","btn p-0",3,"click",4,"ngIf"],["type","button",1,"btn","btn-sm",3,"click"],[1,"bi","bi-send","fs-5"],[1,"bi","bi-gear","fs-5",2,"cursor","pointer"],[1,"text-center","text-muted","mt-5"],["class","text-center my-2",4,"ngIf"],[1,"d-flex","mb-2",3,"ngClass"],[1,"msg-bubble",3,"ngClass"],[4,"ngIf"],[1,"msg-time"],[1,"text-center","my-2"],[1,"px-3","py-1","rounded-pill","small","text-muted"],["alt","Image",2,"max-width","200px","border-radius","8px",3,"src"],["controls","",2,"max-width","200px","border-radius","8px",3,"src"],["controls","",3,"src"],[1,"p-2","position-relative",2,"display","inline-block"],[1,"btn","btn-light","btn-sm","position-absolute",2,"top","5px","right","5px","border-radius","50%",3,"click"],["alt","Aper\xE7u",2,"max-width","200px","border-radius","8px",3,"src"],["type","button",1,"btn","p-0",3,"click"],[1,"bi","bi-mic","fs-5","text-dark"],[1,"bi","bi-stop-circle","fs-5","text-danger"]],template:function(e,t){if(e&1){let l=w();o(0,"ion-content",2)(1,"div",3)(2,"div",4)(3,"i",5),_("click",function(){return h(l),f(t.goBack())}),d(),p(4,"img",6),o(5,"div",7)(6,"h6",8),v(7),d(),o(8,"small",9),v(9),d()()(),o(10,"div",10,0),y(12,le,2,0,"div",11)(13,ge,11,17,"div",12),p(14,"div",null,1),d(),y(16,ve,5,2,"div",13),o(17,"div",14)(18,"label",15),p(19,"i",16),o(20,"input",17),_("change",function(g){return h(l),f(t.onFileSelected(g))}),d()(),o(21,"input",18),B("ngModelChange",function(g){return h(l),V(t.newMessage,g)||(t.newMessage=g),f(g)}),_("keydown.enter",function(){return h(l),f(t.sendMessage())}),d(),y(22,_e,2,0,"button",19)(23,be,2,0,"button",19),o(24,"button",20),_("click",function(){return h(l),f(t.sendMessage())}),p(25,"i",21),d(),p(26,"i",22),d()()()}e&2&&(s(4),c("src",(t.user==null?null:t.user.profileImage)||"assets/img/myLOve/suggestion/user4.png",b),s(3),P("",t.user==null?null:t.user.prenom," ",t.user==null?null:t.user.nom),s(2),E(t.user==null?null:t.user.is_online),s(3),c("ngIf",t.messages.length===0),s(),c("ngForOf",t.messages),s(3),c("ngIf",t.previewUrl),s(5),R("ngModel",t.newMessage),s(),c("ngIf",!t.isRecording),s(),c("ngIf",t.isRecording))},dependencies:[N,z,L,W,G,q,H,J,Z,X,$],styles:[".chat-input[_ngcontent-%COMP%]{position:relative}.msg-bubble[_ngcontent-%COMP%]{border-radius:20px;padding:10px 14px;font-size:.95rem;max-width:75%;position:relative;box-shadow:0 1px 3px #0000001a;display:inline-block}.msg-bubble.sent[_ngcontent-%COMP%]{background-color:#000;color:#fff;margin-left:auto;border-bottom-right-radius:0}.msg-bubble.received[_ngcontent-%COMP%]{background-color:#f0f0f0;color:#000;margin-right:auto;border-bottom-left-radius:0}.msg-time[_ngcontent-%COMP%]{font-size:.7rem;color:gray;margin-top:4px;text-align:right}"]});let r=a;return r})();export{Fe as ChatPage};
