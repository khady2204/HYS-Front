import{a as te}from"./chunk-M3YTEPZY.js";import{a as ee}from"./chunk-YIKDUMCI.js";import{a as Z}from"./chunk-O7TI7L7T.js";import{c as R,d as B,g as G,h as H,i as J,j as K,k as Q,l as W,m as X}from"./chunk-SKEETBT7.js";import{a as Y}from"./chunk-NUWLO4TS.js";import{h as N,i as V}from"./chunk-RETT3Y54.js";import{$b as A,Ab as T,Ac as q,Da as M,Eb as F,Ha as p,Va as m,W as h,Wa as n,X as x,Xa as s,Xb as $,Ya as g,Yb as L,Zb as U,_b as j,ab as b,bb as v,cc as z,fb as P,gb as w,ib as u,pb as k,qa as E,qb as d,sa as l,sb as C,tb as O,xa as f,zb as S}from"./chunk-WVCMXTPH.js";import"./chunk-AAGPOIMH.js";import"./chunk-HFL6MWQG.js";import"./chunk-UJWRXINH.js";import"./chunk-4XRDT473.js";import"./chunk-OAZACCPN.js";import"./chunk-CLDSZD2A.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-DVVH2KKN.js";import"./chunk-NV3QH4JK.js";import"./chunk-HHPFJLTL.js";import"./chunk-OZYWYLNK.js";import"./chunk-42C7ZIID.js";import{a as D,b as y}from"./chunk-JHI3MBHO.js";var ie=e=>["/profile",e],ne=()=>[1,2,3,4],se=()=>["/report-partner"];function oe(e,r){e&1&&(n(0,"div",8)(1,"div"),g(2,"img",22),s(),n(3,"span",23),d(4,"statut"),s()())}function re(e,r){e&1&&(n(0,"div",24),d(1," Aucune discussion pour le moment. "),s())}function ae(e,r){e&1&&(n(0,"span"),g(1,"i",42),d(2," Image "),s())}function ce(e,r){e&1&&(n(0,"span"),g(1,"i",43),d(2," Vid\xE9o "),s())}function le(e,r){e&1&&(n(0,"span"),g(1,"i",44),d(2," Audio "),s())}function me(e,r){if(e&1&&(n(0,"span"),d(1),s()),e&2){let a=u(3).$implicit;l(),C(" ",a.messages[a.messages.length-1]==null?null:a.messages[a.messages.length-1].content," ")}}function ge(e,r){if(e&1&&(b(0)(1,39),p(2,ae,3,0,"span",40)(3,ce,3,0,"span",40)(4,le,3,0,"span",40)(5,me,2,1,"span",41),v()()),e&2){let a=u(2).$implicit;l(),m("ngSwitch",a.messages[a.messages.length-1]==null?null:a.messages[a.messages.length-1].mediaType),l(),m("ngSwitchCase","image"),l(),m("ngSwitchCase","video"),l(),m("ngSwitchCase","audio")}}function de(e,r){e&1&&d(0,"Aucun message")}function ue(e,r){if(e&1&&(n(0,"ion-badge",45),d(1),s()),e&2){let a=u(2).$implicit;l(),C(" ",a.unreadCount," ")}}function pe(e,r){if(e&1){let a=P();b(0),n(1,"ion-item-options",26)(2,"ion-item-option",27),w("click",function(){h(a);let i=u().$implicit,o=u();return x(o.supprimer(i))}),g(3,"i",28),s(),n(4,"ion-item-option",29),g(5,"i",30),s()(),n(6,"ion-item",31),w("click",function(){h(a);let i=u().$implicit,o=u();return x(o.navigateToChat(i.ami.id))}),n(7,"ion-avatar",32),g(8,"img",33),s(),n(9,"ion-label",34)(10,"h6",35),d(11),s(),n(12,"p",36),p(13,ge,6,4,"ng-container",37)(14,de,1,0,"ng-template",null,0,F),s()(),p(16,ue,2,1,"ion-badge",38),s(),v()}if(e&2){let a=k(15),t=u().$implicit;l(4),m("routerLink",S(7,se)),l(4),m("src",t.ami.profileImage||"assets/img/default-avatar.png",E),l(3),O(" ",t.ami.prenom," ",t.ami.nom," "),l(2),m("ngIf",t.messages.length>0)("ngIfElse",a),l(3),m("ngIf",t.unreadCount&&t.unreadCount>0)}}function _e(e,r){if(e&1&&(n(0,"ion-item-sliding"),p(1,pe,17,8,"ng-container",25),s()),e&2){let a=r.$implicit,t=u();l(),m("ngIf",a.ami.id!==t.currentUserId)}}var Ee=(()=>{let r=class r{constructor(t,i,o){this.router=t,this.messageService=i,this.userService=o,this.showDrawer=!1,this.discussions=[],this.currentUserId=0,this.userId=null}ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}let t=this.userService.getUser();this.userId=t?.id??null,this.currentUserId=this.userService.getUserId()??0,this.loadDiscussions()}loadDiscussions(){this.messageService.getAllDiscussions().subscribe({next:t=>{console.log("\u{1F4C2} Discussions brutes :",t),this.discussions=t.map(i=>{let o=i.messages.filter(I=>!I.read&&I.receiverId===this.currentUserId),c=i.messages.length?i.messages[i.messages.length-1]:null,_=c?c.timestamp:"";return console.log(`\u{1F4AC} Discussion avec ${i.ami.prenom} ${i.ami.nom}`),console.log("\u{1F4E8} Messages non lus pour moi:",o.length),console.log("\u{1F552} Dernier message:",_),y(D({},i),{unreadCount:o.length,lastMessageTimestamp:_})}).sort((i,o)=>{let c=(o.unreadCount??0)-(i.unreadCount??0);return c!==0?c:new Date(o.lastMessageTimestamp).getTime()-new Date(i.lastMessageTimestamp).getTime()}),console.log("\u{1F4C8} Discussions apr\xE8s tri :",this.discussions)},error:t=>{console.error("\u274C Erreur chargement discussions",t)}})}toggleDrawer(){this.showDrawer=!this.showDrawer}supprimer(t){this.discussions=this.discussions.filter(i=>i.ami.id!==t?.user?.id)}navigateToChat(t){this.openDiscussion(t)}openDiscussion(t){console.log("\u{1F50D} Ouverture de la discussion avec userId:",t);let i=this.discussions.find(c=>c.ami.id===t);if(!i){console.warn("\u26A0\uFE0F Discussion introuvable pour userId:",t);return}console.log("\u{1F4E6} Discussion trouv\xE9e:",i);let o=i.messages.filter(c=>!c.read&&c.senderId!==this.currentUserId);console.log("\u{1F464} ID utilisateur courant:",this.currentUserId),console.log(`\u{1F4E8} ${o.length} message(s) non lu(s) \xE0 marquer`),o.forEach(c=>{console.log(`\u27A1\uFE0F Tentative de marquage du message ${c.id} comme lu`),c.read=!0,this.messageService.markMessageAsRead(c.id).subscribe({next:()=>console.log(`\u2705 Message ${c.id} marqu\xE9 comme lu c\xF4t\xE9 serveur`),error:_=>{console.error(`\u274C Erreur lors du marquage du message ${c.id}`,_),c.read=!1}})}),i.unreadCount=0,console.log("\u{1F504} Compteur de messages non lus r\xE9initialis\xE9"),this.router.navigate(["/chat",t],{state:{user:i.ami,messages:i.messages}}),console.log("\u{1F680} Navigation vers /chat avec userId:",t)}};r.\u0275fac=function(i){return new(i||r)(f(N),f(te),f(Y))},r.\u0275cmp=M({type:r,selectors:[["app-discussions"]],decls:26,vars:7,consts:[["noMessage",""],[1,"bg-pink"],[1,"header","px-3","pt-5","pb-3"],[1,"d-flex","align-items-center","justify-content-between","pb-3"],[1,"bi","bi-search","fs-4","text-white","rounded-circle","d-flex","align-items-center","justify-content-center"],[3,"routerLink"],["src","assets/img/myLOve/suggestion/tabProfile.png","alt","Profile","width","40","height","40",1,"rounded-circle","border","border-white"],[1,"d-flex","overflow-auto","gap-3","pt-2","pb-1","px-3"],[1,"d-flex","flex-column","pb-3","align-items-center","text-white","text-center",2,"font-size","0.7rem"],[1,"position-relative"],["src","assets/img/myLOve/suggestion/tabProfile.png","width","55","height","55",1,"rounded-circle","border","border-white"],[1,"position-absolute","bottom-0","end-0","bg-white","text-pink","rounded-circle",2,"width","18px","height","18px","font-size","1rem","display","flex","align-items","center","justify-content","center"],[1,"bi","bi-plus","text-black"],[1,"mt-1"],["class","d-flex flex-column pb-3 align-items-center text-white text-center","style","font-size: 0.7rem;",4,"ngFor","ngForOf"],[1,"d-flex","w-100","position-relative",2,"margin-top","-27px"],["tabindex","-1","aria-disabled","true",1,"tab-button","active","disabled"],["href","suggestion",1,"tab-button","inactive"],[1,"px-3","mt-3"],[1,"discussion-item"],["class","text-center text-muted mt-5",4,"ngIf"],[4,"ngFor","ngForOf"],["src","assets/img/myLOve/suggestion/user2.png",1,"rounded-circle","bg-grey",2,"object-fit","cover","display","block","height","55px"],[1,"mt-1","user-status"],[1,"text-center","text-muted","mt-5"],[4,"ngIf"],["side","end"],[1,"bg-red",3,"click"],[1,"bi","bi-trash-fill","text-white","fs-5","d-flex","align-items-center","justify-content-center","w-100","h-100"],[1,"bg-yellow",3,"routerLink"],[1,"bi","bi-flag-fill","text-white","fs-5","d-flex","align-items-center","justify-content-center","w-100","h-100"],["button","",3,"click"],["slot","start"],[3,"src"],[1,"ion-text-wrap"],[1,"fw-bold","mb-1"],[1,"text-muted","small","mb-0",2,"display","flex","align-items","center","gap","4px"],[4,"ngIf","ngIfElse"],["color","danger",4,"ngIf"],[3,"ngSwitch"],[4,"ngSwitchCase"],[4,"ngSwitchDefault"],[1,"bi","bi-image"],[1,"bi","bi-camera-video"],[1,"bi","bi-mic"],["color","danger"]],template:function(i,o){i&1&&(n(0,"ion-content",1)(1,"div",2)(2,"div",3),g(3,"i",4)(4,"app-dropdown-drawer"),n(5,"a",5),g(6,"img",6),s()(),n(7,"div",7)(8,"div",8)(9,"div",9),g(10,"img",10),n(11,"div",11),g(12,"i",12),s()(),n(13,"span",13),d(14,"mon statut"),s()(),p(15,oe,5,0,"div",14),s()(),n(16,"div",15)(17,"a",16),d(18,"Discussions"),s(),n(19,"a",17),d(20,"Suggestions"),s()(),n(21,"div",18)(22,"ion-list",19),p(23,re,2,0,"div",20)(24,_e,2,1,"ion-item-sliding",21),s()(),g(25,"app-floating-menu"),s()),i&2&&(l(5),m("routerLink",T(4,ie,o.userId)),l(10),m("ngForOf",S(6,ne)),l(8),m("ngIf",(o.discussions==null?null:o.discussions.length)===0),l(),m("ngForOf",o.discussions))},dependencies:[z,$,L,U,j,A,q,V,G,X,H,Q,K,R,W,J,B,Z,ee],styles:[".header[_ngcontent-%COMP%]{background-color:#ff008a}.bi-search[_ngcontent-%COMP%]{background-color:#000;width:40px;height:40px;font-size:1.3rem}.bg-pink[_ngcontent-%COMP%]{background-color:#ff008a}.tab-button[_ngcontent-%COMP%]{flex:1;padding:.6rem 1rem;font-weight:600;font-size:.9rem;text-align:center;cursor:pointer;transition:.2s ease-in-out;text-decoration:none}.tab-button.active[_ngcontent-%COMP%]{background-color:#fff;color:#000;border-top-left-radius:80px;border-bottom-right-radius:30px}.tab-button.inactive[_ngcontent-%COMP%]{background-color:#000;color:#fff;border-bottom-left-radius:30px;border-top-right-radius:80px}.discussion-item[_ngcontent-%COMP%]{position:relative}.discussion-item[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{font-size:.75rem}.bg-red[_ngcontent-%COMP%]{background-color:#ff3b30!important}.bg-yellow[_ngcontent-%COMP%]{background-color:#fc0!important}.text-white[_ngcontent-%COMP%]{color:#fff!important}"]});let e=r;return e})();export{Ee as DiscussionsPage};
