<ion-content class="" fullscreen>
  <div class="container py-3 content-offset">

    <!--Header-->
    <app-header-search></app-header-search>

    <!-- Stories -->
 <!-- Stories -->
    <div class="mb-3 story-container">
      <div class="overflow-auto">
        <div class="d-flex gap-3 flex-nowrap">
          <div class="text-center">
            <div class="story-ring me-1 d-flex justify-content-center align-items-center"
              style="width: 56px; height: 56px;" (click)="openMyStories()">
              <i class="bi bi-person text-grey fs-2"></i>
            </div>
            <small class="d-block mt-8">Moi</small>
          </div>

          <div class="text-center">
            <div class="story-ring me-1 d-flex justify-content-center align-items-center"
              style="width: 56px; height: 56px;" (click)="openAddStory()">
              <i class="bi bi-plus text-grey fs-2"></i>
            </div>
            <small class="d-block mt-1">Ajouter</small>
          </div>

          <!-- Loading state -->
          <div *ngIf="isLoading" class="text-center">
            <div class="story-ring me-1 d-flex justify-content-center align-items-center"
              style="width: 56px; height: 56px;">
              <i class="bi bi-arrow-clockwise text-grey fs-2"></i>
            </div>
            <small class="d-block mt-1">Chargement...</small>
          </div>

          <!-- Error state -->
          <!-- <div *ngIf="error" class="text-center">
            <div class="story-ring me-1 d-flex justify-content-center align-items-center"
              style="width: 56px; height: 56px;">
              <i class="bi bi-exclamation-triangle text-danger fs-2"></i>
            </div>
            <small class="d-block mt-1 text-danger">{{ error }}</small>
          </div> -->

          <!-- Stories groupées par utilisateur -->
          <div class="text-center" *ngFor="let userStory of userStories" (click)="openStory(userStory)">
            <div [ngClass]="userStory.hasUnreadStories ? 'story-ring unread' : 'story-ring read'">
              <img [src]="userStory.userProfileImage || 'assets/img/myLOve/account.png'" alt="" class="story-avatar">
              <!-- Indicateur de nombre de stories -->
              <div *ngIf="userStory.totalStories > 1" class="story-count">
                {{ userStory.totalStories }}
              </div>
            </div>
            <small class="d-block mt-1 text-truncate" style="width: 56px;">{{ userStory.userFullName }}</small>
          </div>
        </div>
      </div>
    </div>
    <!-- Section Publications -->
    <div class="publications-section">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h6 class="mb-0  fw-bold text-primary">Publications</h6>
        <small class="text-muted">{{ publications.length }} publication(s)</small>
      </div>

      <!-- Message de chargement -->
      <div *ngIf="isLoadingPublications && publications.length === 0" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="text-muted mt-2">Chargement des publications...</p>
      </div>

      <!-- Message d'erreur -->
      <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ error }}
        <button type="button" class="btn-close" (click)="error = null"></button>
      </div>

      <!-- Liste des publications -->
      <div *ngFor="let pub of publications" class="publication-card mb-4">

        <!-- En-tête de la publication -->
        <div class="publication-header">
          <div class="d-flex align-items-center">
            <div class="position-relative">
              <img [src]="pub.auteurAvatar || 'assets/img/myLOve/account.png'" [alt]="pub.auteurNom"
                class="author-avatar">
            </div>
            <div class="ms-3 flex-grow-1">
              <h6 class="mb-0 fw-semibold">{{ pub.auteurNom }}</h6>
              <small class="text-muted">{{ getRelativeTime(pub.createdAt) }}</small>
            </div>
            <div class="dropdown" *ngIf="canDeletePublication(pub)">
              <button class="btn btn-link text-muted p-1" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <button class="dropdown-item text-danger" (click)="supprimerPublication(pub.id)">
                    <i class="bi bi-trash me-2"></i>Supprimer
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <!-- Contenu textuel -->
        <div class="publication-content" *ngIf="pub.texte">
          <p class="mt-3 mb-3">{{ pub.texte }}</p>
        </div>

        <!-- Médias -->
        <div class="publication-media" *ngIf="pub.medias && pub.medias.length > 0">

          <!-- Un seul média -->
          <div *ngIf="pub.medias.length === 1" class="single-media">
            <div *ngFor="let media of pub.medias" class="media-item">
              <img *ngIf="media.type === 'image'" [src]="getFullMediaUrl(media.url)"
                [alt]="media.description || 'Image de publication'" class="media-content single-image" loading="lazy">
              <video *ngIf="media.type === 'video'" [src]="getFullMediaUrl(media.url)"
                class="media-content single-video" controls preload="metadata">
                Votre navigateur ne supporte pas la vidéo.
              </video>
            </div>
          </div>

          <!-- Plusieurs médias -->
          <div *ngIf="pub.medias.length > 1" class="multiple-media">
            <div class="media-grid" [class]="'grid-' + Math.min(pub.medias.length, 4)">
              <div *ngFor="let media of pub.medias.slice(0, 4); let i = index" class="media-item"
                [class.media-overlay]="i === 3 && pub.medias.length > 4">
                <img *ngIf="media.type === 'image'" [src]="getFullMediaUrl(media.url)"
                  [alt]="media.description || 'Image de publication'" class="media-content grid-image" loading="lazy">
                <video *ngIf="media.type === 'video'" [src]="getFullMediaUrl(media.url)"
                  class="media-content grid-video" muted preload="metadata">
                </video>
                <!-- Overlay pour "voir plus" -->
                <div *ngIf="i === 3 && pub.medias.length > 4" class="media-more-overlay">
                  <span class="more-count">+{{ pub.medias.length - 4 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions de la publication -->
        <div class="publication-actions">
          <div class="action-buttons">
            <!-- Like -->
            <button class="action-btn like-btn" [class.active]="pub.liked" (click)="toggleLike(pub)">
              <i class="bi" [class]="pub.liked ? 'bi-heart-fill' : 'bi-heart'"></i>
            </button>

            <!-- Commentaires -->
            <button class="action-btn comment-btn" (click)="openComments(pub)">
              <i class="bi bi-chat"></i>
            </button>

            <!-- Partage -->
            <button class="action-btn share-btn" (click)="partagerPublication(pub)">
              <i class="bi bi-share"></i>
            </button>
          </div>

          <!-- Compteurs -->
          <div class="action-counters mt-2">
            <span *ngIf="pub.nombreLikes > 0" class="counter-item">
              <i class="bi bi-heart-fill text-danger me-1"></i>
              {{ pub.nombreLikes }} J'aime
            </span>
            <span *ngIf="pub.nombreCommentaires > 0" class="counter-item ms-3">
              <i class="bi bi-chat me-1"></i>
              {{ pub.nombreCommentaires }} commentaire(s)
            </span>
            <span *ngIf="pub.nombrePartages > 0" class="counter-item ms-3">
              <i class="bi bi-share me-1"></i>
              {{ pub.nombrePartages }} partage(s)
            </span>
          </div>
        </div>
      </div>

      <!-- Bouton charger plus -->
      <div *ngIf="currentPage < totalPages - 1" class="text-center mt-4">
        <button class="btn btn-outline-primary" (click)="loadMorePublications()" [disabled]="isLoadingPublications">
          <span *ngIf="!isLoadingPublications">Voir plus de publications</span>
          <span *ngIf="isLoadingPublications">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Chargement...
          </span>
        </button>
      </div>

      <!-- Message si aucune publication -->
      <div *ngIf="!isLoadingPublications && publications.length === 0" class="text-center py-5">
        <i class="bi bi-journal-x display-1 text-muted"></i>
        <h5 class="text-muted mt-3">Aucune publication</h5>
        <p class="text-muted">Soyez le premier à publier quelque chose !</p>
      </div>
    </div>




  </div>

  <!-- Menu flottant bas -->
  <app-floating-menu></app-floating-menu>

  <!-- Debug Section (à retirer en production) -->
  <!-- <div class="debug-section p-3 mt-3" style="background: #f8f9fa; border-radius: 8px;">
    <h6 class="text-muted">Debug Info</h6>
    <div class="small">
      <div><strong>API Base:</strong> {{ getApiBase() }}</div>
      <div><strong>User ID:</strong> {{ getCurrentUserId() }}</div>
      <div><strong>Users with stories:</strong> {{ userStories.length }}</div>
      <div><strong>Loading:</strong> {{ isLoading }}</div>
      <div><strong>Error:</strong> {{ error || 'Aucune' }}</div>
    </div>
  </div> -->

  <!-- Add Story Modal -->
  <ion-modal [isOpen]="isAddStoryOpen" (didDismiss)="closeAddStory()">
    <ng-template>
      <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Ajouter une story</h5>
          <button class="btn btn-light" (click)="closeAddStory()">
            <i class="bi bi-x"></i>
          </button>
        </div>

        <div class="mb-3">
          <label class="form-label">Texte (optionnel)</label>
          <textarea class="form-control" rows="3" placeholder="Racontez votre histoire..." [(ngModel)]="newStoryText">
          </textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Média (image/vidéo) - Optionnel</label>
          <input type="file" class="form-control" accept="image/*,video/*" multiple (change)="onFileSelected($event)">
          <small class="text-muted">Vous pouvez sélectionner plusieurs fichiers ou aucun pour du texte seul</small>
        </div>

        <div class="d-grid">
          <button class="btn btn-primary" (click)="postStory()" [disabled]="isPosting">
            {{ isPosting ? 'Publication...' : 'Publier' }}
          </button>
        </div>

        <div *ngIf="error" class="alert alert-danger mt-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          {{ error }}
        </div>
      </div>
    </ng-template>
  </ion-modal>

  <!-- My Stories Modal -->
  <ion-modal [isOpen]="isMyStoriesOpen" (didDismiss)="closeMyStories()">
    <ng-template>
      <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Mes Stories</h5>
          <button class="btn btn-light" (click)="closeMyStories()">
            <i class="bi bi-x"></i>
          </button>
        </div>

        <div *ngIf="myStories.length === 0" class="text-center py-4">
          <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
          <p class="text-muted mt-2">Aucune story publiée</p>
          <button class="btn btn-primary" (click)="openAddStory(); closeMyStories()">
            Créer ma première story
          </button>
        </div>

        <div *ngFor="let story of myStories" class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div *ngIf="story.text" class="mb-2">{{ story.text }}</div>
                <div *ngIf="story.mediaUrls && story.mediaUrls.length > 0" class="mb-2">
                  <img *ngFor="let url of story.mediaUrls" [src]="url" alt="Média" class="img-thumbnail me-2"
                    style="width: 60px; height: 60px; object-fit: cover;">
                </div>
                <small class="text-muted">
                  Publié le {{ story.createdAt | date:'dd/MM/yyyy à HH:mm' }}
                </small>
              </div>
              <button class="btn btn-outline-danger btn-sm ms-2" (click)="deleteStory(story.id)"
                title="Supprimer cette story">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>

  <!-- Story Viewer Modal -->
  <app-story-viewer *ngIf="isViewerOpen && selectedUserStories" [userStories]="selectedUserStories"
    [initialStoryIndex]="0" (close)="closeViewer()">
  </app-story-viewer>

</ion-content>
